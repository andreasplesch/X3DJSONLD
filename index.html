<!doctype html>
<html>
<head>
    <title>JSON Loader</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="http://www.x3dom.org/download/1.7.1/x3dom.css"></link>
    <script type="text/javascript" src="http://www.x3dom.org/download/1.7.1/x3dom-full.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <style type="text/css">
    X3D {
        background:#000;
    }
    table td, table td * {
        vertical-align: top;
    }
    </style>
</head>
<body>
<table>
<tr>
<td>
<select>
<option>flipper.json</option>
<option>force.json</option>
<option>forces.json</option>
<option>ArchHalf.json</option>
<option>ArchPrototype.json</option>
<option>ArchPrototypes.json</option>
<option>examples/X3dForAdvancedModeling/Buildings/ArchPrototype.json</option>
<option>bubbles.json</option>
<option>geobubbles.json</option>
<!--option>geo.json</option-->
<option>ObliqueStrategies.json</option>
<option>IcosahedronSubdivisionLevel5.json</option>
<option>ExtrusionHeart.json</option>
<option>cobweb.json</option>
<option>cobwebs.json</option>
<option>pp3.json</option>
<option>pp3s.json</option>
<option>qq3.json</option>
<option>qq3s.json</option>
</select>
</td>
<td>
<input type="text" onchange="filter(event)"></input>
Use Prototype Expander? <input id="prototype" type="checkbox"></input>
</td>
</tr>
<tr>
<td>
Click <a onclick='updateXML();'>here</a> to load X3D XML into Cobweb and XML X3DOM viewer. Does not convert to JSON.<br>
			
	    
<textarea id="xml" rows="15" cols="80"></textarea><br>
<div id="x3domxml"></div>
<iframe  id='cobwebframe' src="cobwebframe.html"></iframe>
</td>
<td>
Click <a onclick='updateX3DOM();'>here</a> to load X3D JSON text into JSON X3DOM viewer and convert to XML (and display).<br>
<textarea id="json" rows="15" cols="80"></textarea><br>
<div id="x3domjson"></div>
</td>
</tr>
</table>
</body>
    <script type="text/javascript" src="X3DJSONLD.js"></script>
    <script type="text/javascript" src="PrototypeExpander.js"></script>
    <script type="text/javascript" src="Script.js"></script>
    <script type="text/javascript" id="scripts"></script>
    <script type="text/javascript" id="routes"></script>

    <script type="text/javascript">
        function updateXML(xml) {
		if (typeof xml !== 'undefined') {
			// DISPLAY XML in X3DOM
			$('#x3domxml').empty();
			// Do this inner HTML so we can sneak script tag past JQuery (BAD BAD TODO)
			$('#x3domxml').get()[0].innerHTML = xml.join("");
	    	        $('textarea#xml').val(xml.join(""));
		} else {
			$('#x3domxml').get()[0].innerHTML = $('textarea#xml').val();
		}
		x3dom.reload();
		var content = $('textarea#xml').val();
		var cobwebWindow = document.getElementById("cobwebframe").contentWindow ;
		var cobwebEle = cobwebWindow.document.getElementById("x3dele");
		if (typeof cobwebWindow.X3D !== 'undefined') {
			var browser = cobwebWindow.X3D.getBrowser(cobwebEle);
			browser.replaceWorld(browser.createX3DFromString(content));
		} else {
			console.error("Cobweb disabled.  Use Firefox.");
		}
        }

	function filter(event) {
		$.map($("select option"), function(option, i) {
			var text = $(option).text();
			if (text.indexOf(event.target.value) >= 0) {
				$(option).show();
				return true;
			} else {
				$(option).hide();
				return false;
			}
		});
	}

        function loadX3DOM(selector, json, url) {
	    $(selector+" X3D").remove();
	    var xml = [];
	    if ($('#prototype').is(':checked')) {

		// Expand Protos
		prototypeExpander(json, "");

		// Now generate JavaScript code for Scripts and Routes
		var classes = [];
		var routecode = [];
		routecode.push("var intervalId = setInterval(function() {");
		processScripts(json, classes, undefined, routecode);
		routecode.push("}, 500);");
		classes.push("};");
		// console.log(classes.join('\n'));
		// console.log(routecode.join('\n'));
		var scripts = document.getElementById("scripts");
		if (typeof intervalId !== 'undefined') {
			clearInterval(intervalId);
		}
		if (typeof X3DJSON !== 'undefined') {
			delete X3DJSON;
		}
		if (typeof scripts.lastChild === 'Node') {
			scripts.removeChild(scripts.lastChild);
		}
		scripts.text = classes.join("\n")
			.replace(/&lt;/g, '<')
			.replace(/&gt;/g, '>');

		var routes = document.getElementById("routes");
		if (typeof routes.lastChild === 'Node') {
			routes.removeChild(routes.lastChild);
		}
		routes.text = routecode.join("\n");
		// When we zap the source, we prevent animation
		// zapSource(json);
	        $('textarea#json').val(JSON.stringify(json, null, 2));
	    }
	    loadX3DJS(selector, json, url, xml);
			
	    updateXML(xml);
        }

	function updateX3DOM() {
		loadX3DOM("#x3domjson", JSON.parse($('textarea#json').val()), "flipper.json"); // does not load flipper.json
	}

	function loadX3DJSON(selector, url) {
		$.getJSON(url, function(json) {
			$('textarea#json').val(JSON.stringify(json, null, 2));
			loadX3DOM(selector, JSON.parse($('textarea#json').val()), url);
		})
		.fail(function(jqXHR, textStatus, errorThrown) { alert('getJSON request failed! ' + textStatus + ' ' + errorThrown); });
	}

	$("select").change(function() {
		$("X3D").remove();
		var url = $('select option:selected').text();
		loadX3DJSON('#x3domjson', url);
	});

	$(document).ready(function() {
		loadX3DJSON('#x3domjson','flipper.json'); // does load flipper.json
	});
    </script>
</html>
